<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing - Pro Forex Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #050510; min-height: 100vh; color: #e6edf3; overflow-x: hidden; }
        
        .jjk-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: radial-gradient(ellipse at center, #0a0520 0%, #050510 100%); }
        .domain-expansion { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle at 20% 80%, rgba(138,43,226,0.15) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(75,0,130,0.15) 0%, transparent 50%); animation: domainPulse 8s ease-in-out infinite; }
        @keyframes domainPulse { 0%,100%{opacity:0.6;transform:scale(1)} 50%{opacity:1;transform:scale(1.05)} }
        .cursed-orb { position: absolute; border-radius: 50%; filter: blur(60px); animation: orbFloat 20s ease-in-out infinite; }
        .orb-1 { width:400px;height:400px;background:radial-gradient(circle,rgba(138,43,226,0.4) 0%,transparent 70%);top:-100px;left:-100px; }
        .orb-2 { width:500px;height:500px;background:radial-gradient(circle,rgba(75,0,130,0.35) 0%,transparent 70%);bottom:-150px;right:-150px;animation-delay:-5s; }
        @keyframes orbFloat { 0%,100%{transform:translate(0,0) scale(1)} 50%{transform:translate(-20px,20px) scale(0.95)} }

        .container { max-width:1200px; margin:0 auto; padding:20px; position:relative; z-index:10; }
        .back-btn { display:inline-flex; align-items:center; gap:8px; color:#b388ff; text-decoration:none; margin-bottom:30px; padding:12px 24px; border-radius:12px; background:rgba(138,43,226,0.1); border:1px solid rgba(138,43,226,0.3); transition:all 0.3s ease; }
        .back-btn:hover { background:rgba(138,43,226,0.2); box-shadow:0 0 20px rgba(138,43,226,0.3); }
        
        .page-header { text-align:center; margin-bottom:50px; }
        .page-title { font-size:3rem; font-weight:800; background:linear-gradient(135deg,#e1bee7,#ba68c8,#9c27b0); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
        .page-subtitle { color:#b388ff; font-size:1.1rem; margin-top:10px; }
        
        /* Current subscription banner */
        .current-plan-banner { background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,212,255,0.1)); border: 1px solid rgba(0,255,136,0.3); border-radius: 16px; padding: 20px; margin-bottom: 30px; text-align: center; }
        .current-plan-banner h3 { color: #00ff88; margin-bottom: 8px; }
        .current-plan-banner .plan-name { font-size: 1.5rem; font-weight: 800; background: linear-gradient(135deg, #ffd700, #ff8c00); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .current-plan-banner .plan-name.pro { background: linear-gradient(135deg, #00d4ff, #00ff88); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .current-plan-banner .expiry { color: #b388ff; font-size: 0.9rem; margin-top: 8px; }
        
        .pricing-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:25px; margin-bottom:50px; }
        @media(max-width:900px) { .pricing-grid { grid-template-columns:1fr; max-width:400px; margin:0 auto 50px; } }
        
        .pricing-card { background:rgba(20,10,40,0.7); backdrop-filter:blur(20px); border-radius:24px; padding:35px 30px; border:1px solid rgba(138,43,226,0.2); position:relative; transition:all 0.4s ease; }
        .pricing-card:hover { transform:translateY(-10px); border-color:rgba(186,85,211,0.5); box-shadow:0 25px 50px rgba(138,43,226,0.3); }
        .pricing-card.popular { border-color:rgba(0,212,255,0.4); transform:scale(1.05); }
        .pricing-card.popular:hover { transform:scale(1.08) translateY(-10px); }
        .pricing-card.premium-card { background:linear-gradient(135deg,rgba(30,15,50,0.9),rgba(60,30,10,0.3)); border-color:rgba(255,215,0,0.3); }
        
        .popular-badge { position:absolute; top:-1px; left:50%; transform:translateX(-50%); background:linear-gradient(135deg,#00d4ff,#00ff88); color:#0a0a1a; padding:8px 25px; border-radius:0 0 15px 15px; font-size:0.75rem; font-weight:700; }
        .tier-name { font-size:1.4rem; font-weight:700; color:#e1bee7; margin-bottom:10px; }
        .tier-name.premium { background:linear-gradient(135deg,#ffd700,#ff8c00); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
        .tier-price { font-size:3rem; font-weight:800; margin-bottom:25px; }
        .tier-price.free { color:#b388ff; }
        .tier-price.pro { background:linear-gradient(135deg,#00d4ff,#00ff88); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
        .tier-price.premium { background:linear-gradient(135deg,#ffd700,#ff8c00); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
        .tier-price span { font-size:0.9rem; color:#7c4dff; }
        .tier-features { list-style:none; margin-bottom:30px; }
        .tier-features li { padding:12px 0; border-bottom:1px solid rgba(138,43,226,0.15); display:flex; align-items:center; gap:10px; font-size:0.9rem; color:#d1c4e9; }
        .check { color:#00ff88; } .x { color:#7c4dff; opacity:0.5; }

        .tier-btn { display:flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:16px; border:none; border-radius:14px; font-size:1rem; font-weight:700; cursor:pointer; text-decoration:none; transition:all 0.3s ease; }
        .tier-btn.current { background:rgba(0,255,136,0.15); color:#00ff88; border:2px solid rgba(0,255,136,0.4); }
        .tier-btn.included { background:rgba(138,43,226,0.15); color:#b388ff; border:2px solid rgba(138,43,226,0.3); cursor:default; }
        .tier-btn.upgrade { background:linear-gradient(135deg,#00d4ff,#00ff88); color:#0a0a1a; }
        .tier-btn.upgrade:hover { transform:translateY(-3px); box-shadow:0 15px 40px rgba(0,212,255,0.4); }
        .tier-btn.premium-btn { background:linear-gradient(135deg,#ffd700,#ff8c00); }
        .tier-btn.premium-btn:hover { box-shadow:0 15px 40px rgba(255,215,0,0.4); }
        .tier-btn.free-btn { background:rgba(138,43,226,0.15); color:#b388ff; border:1px solid rgba(138,43,226,0.3); }
        .tier-btn:disabled { opacity:0.6; cursor:not-allowed; }
        
        .payment-methods { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:40px; }
        @media(max-width:700px) { .payment-methods { grid-template-columns:1fr; } }
        .payment-card { background:rgba(20,10,40,0.7); backdrop-filter:blur(20px); border-radius:20px; padding:30px; border:2px solid rgba(138,43,226,0.2); text-align:center; }
        .payment-card.stripe { border-color:rgba(99,91,255,0.4); }
        .payment-card.local { border-color:rgba(0,128,0,0.4); }
        .payment-card h3 { color:#e1bee7; margin-bottom:15px; font-size:1.2rem; }
        .payment-card p { color:#b388ff; font-size:0.9rem; margin-bottom:15px; }
        .payment-icons { font-size:2rem; margin-bottom:15px; }
        
        .guarantee-section { text-align:center; padding:30px; background:rgba(0,255,136,0.05); border-radius:20px; border:1px solid rgba(0,255,136,0.2); }
        .loading { display:inline-block; width:20px; height:20px; border:2px solid transparent; border-top-color:#0a0a1a; border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
    </style>
</head>
<body>
    <div class="jjk-background">
        <div class="domain-expansion"></div>
        <div class="cursed-orb orb-1"></div>
        <div class="cursed-orb orb-2"></div>
    </div>

    <div class="container">
        <a href="/" class="back-btn">‚Üê Back to Analyzer</a>
        <div class="page-header">
            <h1 class="page-title">Choose Your Plan</h1>
            <p class="page-subtitle">Unlock institutional-grade AI trading analysis</p>
        </div>
        
        {% if user and (user.tier == 'pro' or user.tier == 'premium') %}
        <div class="current-plan-banner">
            <h3>üéâ Your Current Subscription</h3>
            <div class="plan-name {% if user.tier == 'pro' %}pro{% endif %}">
                {% if user.tier == 'premium' %}üëë Premium Plan{% else %}‚≠ê Pro Plan{% endif %}
            </div>
            <div class="expiry">
                üìÖ Valid until: {{ subscription_expiry if subscription_expiry else 'Lifetime Access' }}
            </div>
        </div>
        {% endif %}
        
        <div class="pricing-grid">
            <!-- FREE PLAN -->
            <div class="pricing-card">
                <div class="tier-name">Free</div>
                <div class="tier-price free">$0<span>/month</span></div>
                <ul class="tier-features">
                    <li><span class="check">‚úì</span> 5 analyses per day</li>
                    <li><span class="check">‚úì</span> Basic AI signals</li>
                    <li><span class="check">‚úì</span> M1, M5, M15 timeframes</li>
                    <li><span class="x">‚úó</span> Full 744 concepts</li>
                    <li><span class="x">‚úó</span> Multi-timeframe analysis</li>
                </ul>
                {% if not user %}
                <a href="/login" class="tier-btn free-btn">Get Started Free</a>
                {% elif user.tier == 'free' %}
                <button class="tier-btn current">‚úì Current Plan</button>
                {% else %}
                <button class="tier-btn included">‚úì Included</button>
                {% endif %}
            </div>
            
            <!-- PRO PLAN -->
            <div class="pricing-card popular">
                <div class="popular-badge">‚≠ê Most Popular</div>
                <div class="tier-name">Pro</div>
                <div class="tier-price pro">$19.99<span>/month</span></div>
                <ul class="tier-features">
                    <li><span class="check">‚úì</span> 50 analyses per day</li>
                    <li><span class="check">‚úì</span> Full 744 concepts</li>
                    <li><span class="check">‚úì</span> All timeframes (M1-MN)</li>
                    <li><span class="check">‚úì</span> Multi-timeframe analysis</li>
                    <li><span class="x">‚úó</span> Priority AI processing</li>
                </ul>
                {% if not user %}
                <a href="/login" class="tier-btn upgrade">Login to Upgrade</a>
                {% elif user.tier == 'premium' %}
                <button class="tier-btn included">‚úì Included in Premium</button>
                {% elif user.tier == 'pro' %}
                <button class="tier-btn current">‚úì Current Plan</button>
                {% else %}
                <button class="tier-btn upgrade" onclick="selectPlan('pro')">üöÄ Upgrade to Pro</button>
                {% endif %}
            </div>
            
            <!-- PREMIUM PLAN -->
            <div class="pricing-card premium-card">
                <div class="tier-name premium">üëë Premium</div>
                <div class="tier-price premium">$49.99<span>/month</span></div>
                <ul class="tier-features">
                    <li><span class="check">‚úì</span> Unlimited analyses</li>
                    <li><span class="check">‚úì</span> Full 744 concepts</li>
                    <li><span class="check">‚úì</span> All timeframes (M1-MN)</li>
                    <li><span class="check">‚úì</span> Multi-timeframe analysis</li>
                    <li><span class="check">‚úì</span> Priority AI processing</li>
                </ul>
                {% if not user %}
                <a href="/login" class="tier-btn upgrade premium-btn">Login to Upgrade</a>
                {% elif user.tier == 'premium' %}
                <button class="tier-btn current">‚úì Current Plan</button>
                {% else %}
                <button class="tier-btn upgrade premium-btn" onclick="selectPlan('premium')">üíé Upgrade to Premium</button>
                {% endif %}
            </div>
        </div>

        <div class="payment-methods" id="paymentMethods" style="display:none;">
            <div class="payment-card stripe">
                <div class="payment-icons">üí≥</div>
                <h3>Pay with Card (Global)</h3>
                <p>Visa, Mastercard, Amex, Apple Pay, Google Pay</p>
                <button class="tier-btn upgrade" id="stripePayBtn" onclick="payWithStripe()">üí≥ Pay with Card</button>
            </div>
            <div class="payment-card local">
                <div class="payment-icons">üè¶</div>
                <h3>Pay with KHQR (Cambodia)</h3>
                <p>ACLEDA, ABA, Wing, and all KHQR banks</p>
                <button class="tier-btn upgrade" style="background:linear-gradient(135deg,#00ff88,#00d4ff);" onclick="openKHQRModal()">üá∞üá≠ Pay with KHQR</button>
            </div>
        </div>
        
        <div id="selectedPlanInfo" style="display:none; text-align:center; margin-bottom:30px; padding:20px; background:rgba(138,43,226,0.1); border-radius:16px; border:1px solid rgba(138,43,226,0.3);">
            <p style="color:#b388ff; margin-bottom:10px;">Selected Plan:</p>
            <h3 id="selectedPlanName" style="color:#e1bee7; font-size:1.5rem;"></h3>
            <p id="selectedPlanPrice" style="color:#00ff88; font-size:2rem; font-weight:800;"></p>
            <button onclick="cancelSelection()" style="margin-top:15px; background:none; border:1px solid rgba(138,43,226,0.3); color:#b388ff; padding:8px 20px; border-radius:8px; cursor:pointer;">Cancel</button>
        </div>

        <div class="guarantee-section">
            <div style="font-size:2.5rem; margin-bottom:10px;">üõ°Ô∏è</div>
            <h3 style="color:#00ff88; margin-bottom:10px;">100% Satisfaction Guarantee</h3>
            <p style="color:#b388ff;">Secure payment powered by Stripe. Cancel anytime.</p>
        </div>
    </div>

    <div id="khqrModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(5,5,16,0.95); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:linear-gradient(135deg,rgba(30,15,50,0.95),rgba(20,10,40,0.95)); border-radius:24px; padding:30px; max-width:420px; width:90%; border:2px solid rgba(0,128,0,0.4); position:relative;">
            <button onclick="closeKHQRModal()" style="position:absolute; top:12px; right:15px; background:none; border:none; color:#b388ff; font-size:1.8rem; cursor:pointer;">√ó</button>
            <h2 style="text-align:center; margin-bottom:20px; color:#00ff88; font-size:1.5rem;" id="khqrPlanName">‚≠ê Pro Plan</h2>
            <div style="text-align:center; margin-bottom:20px;">
                <div style="font-size:2rem; font-weight:800; color:#00ff88;" id="khqrPrice">$19.99</div>
            </div>
            <div style="background:#fff; border-radius:16px; padding:15px; text-align:center; margin-bottom:20px;">
                <img src="/static/acleda_qr.png" alt="KHQR" style="width:200px; height:auto; border-radius:8px;">
                <div style="color:#0d1117; font-weight:600; margin-top:10px;">ORM BOUDOM</div>
                <div style="color:#666; font-size:0.85rem;">ACLEDA Bank - KHQR</div>
            </div>
            <div style="margin-bottom:15px;">
                <input type="text" id="transactionRef" placeholder="Transaction ID / Reference" style="width:100%; padding:14px; border-radius:10px; border:1px solid rgba(0,128,0,0.3); background:rgba(20,10,40,0.8); color:#e6edf3;">
            </div>
            <div style="margin-bottom:20px;">
                <input type="file" id="paymentScreenshot" accept="image/*" style="width:100%; padding:12px; border-radius:10px; border:1px solid rgba(0,128,0,0.3); background:rgba(20,10,40,0.8); color:#e6edf3;">
            </div>
            <button onclick="submitKHQR()" style="width:100%; padding:16px; background:linear-gradient(135deg,#00ff88,#00d4ff); border:none; border-radius:12px; color:#0a0a1a; font-size:1.1rem; font-weight:700; cursor:pointer;">‚úÖ Submit Payment</button>
            <p style="text-align:center; color:#7c4dff; font-size:0.8rem; margin-top:15px;">Manual verification: 5-30 minutes</p>
        </div>
    </div>

    <script>
        const stripePublicKey = '{{ stripe_public_key }}';
        const stripe = stripePublicKey ? Stripe(stripePublicKey) : null;
        let selectedPlan = null;
        let selectedPrice = 0;
        
        function selectPlan(plan) {
            selectedPlan = plan;
            selectedPrice = plan === 'pro' ? 19.99 : 49.99;
            document.getElementById('paymentMethods').style.display = 'grid';
            document.getElementById('selectedPlanInfo').style.display = 'block';
            document.getElementById('selectedPlanName').textContent = plan === 'pro' ? '‚≠ê Pro Plan' : 'üëë Premium Plan';
            document.getElementById('selectedPlanPrice').textContent = '$' + selectedPrice.toFixed(2) + '/month';
            document.getElementById('paymentMethods').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function cancelSelection() {
            selectedPlan = null;
            document.getElementById('paymentMethods').style.display = 'none';
            document.getElementById('selectedPlanInfo').style.display = 'none';
        }
        
        async function payWithStripe() {
            if (!selectedPlan) { alert('Please select a plan first'); return; }
            if (!stripe) { alert('Stripe is not configured. Please use KHQR payment.'); return; }
            
            const btn = document.getElementById('stripePayBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Processing...';
            
            try {
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tier: selectedPlan })
                });
                const data = await response.json();
                if (data.error) { 
                    alert('Error: ' + data.error); 
                    btn.disabled = false; 
                    btn.innerHTML = 'üí≥ Pay with Card'; 
                    return; 
                }
                if (data.checkout_url) { 
                    window.location.href = data.checkout_url; 
                }
            } catch (error) {
                alert('Network error. Please try again.');
                btn.disabled = false;
                btn.innerHTML = 'üí≥ Pay with Card';
            }
        }
        
        function openKHQRModal() {
            if (!selectedPlan) { alert('Please select a plan first'); return; }
            document.getElementById('khqrPlanName').textContent = selectedPlan === 'pro' ? '‚≠ê Pro Plan' : 'üëë Premium Plan';
            document.getElementById('khqrPrice').textContent = '$' + selectedPrice.toFixed(2);
            document.getElementById('khqrModal').style.display = 'flex';
        }
        
        function closeKHQRModal() { 
            document.getElementById('khqrModal').style.display = 'none'; 
        }
        
        async function submitKHQR() {
            const transactionRef = document.getElementById('transactionRef').value;
            const screenshot = document.getElementById('paymentScreenshot').files[0];
            if (!transactionRef && !screenshot) { 
                alert('Please enter transaction reference or upload screenshot'); 
                return; 
            }
            
            const formData = new FormData();
            formData.append('plan', selectedPlan);
            formData.append('amount', selectedPrice);
            formData.append('transaction_ref', transactionRef);
            if (screenshot) formData.append('screenshot', screenshot);
            
            try {
                const response = await fetch('/api/submit-payment', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success) { 
                    alert('‚úÖ Payment submitted! You will be upgraded within 5-30 minutes.'); 
                    closeKHQRModal(); 
                    window.location.href = '/settings'; 
                } else { 
                    alert('Error: ' + (data.error || 'Failed')); 
                }
            } catch (error) { 
                alert('Network error. Please try again.'); 
            }
        }
        
        document.getElementById('khqrModal').addEventListener('click', function(e) { 
            if (e.target === this) closeKHQRModal(); 
        });
    </script>
</body>
</html>
